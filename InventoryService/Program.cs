using InventoryService.Models;
using InventoryService.Repositories;
using InventoryService.Services;
using Microsoft.EntityFrameworkCore;
using System.Text.Json.Serialization;

var builder = WebApplication.CreateBuilder(args);

// ?????????????????????????????????????????????
// DATABASE: SQL Server
// ?????????????????????????????????????????????
builder.Services.AddDbContext<AppDbContext>(options =>
{
    options.UseSqlServer(builder.Configuration.GetConnectionString("DefaultConnection"));
});

// ?????????????????????????????????????????????
// REPOSITORIES (NO GENERIC REPO)
// ?????????????????????????????????????????????
builder.Services.AddScoped<IDeviceRepository, DeviceRepository>();
builder.Services.AddScoped<IUserRepository, UserRepository>();
builder.Services.AddScoped<ILicenseRepository, LicenseRepository>();
builder.Services.AddScoped<IEntitlementRepository, EntitlementRepository>();
builder.Services.AddScoped<ISoftwareCatalogRepository, SoftwareCatalogRepository>();
builder.Services.AddScoped<IInstalledSoftwareRepository, InstalledSoftwareRepository>();
builder.Services.AddScoped<IInstallationHistoryRepository, InstallationHistoryRepository>();
builder.Services.AddScoped<IVendorContractRepository, VendorContractRepository>();

// ?????????????????????????????????????????????
// SERVICES
// ?????????????????????????????????????????????
builder.Services.AddScoped<IDeviceService, DeviceService>();
builder.Services.AddScoped<IUserService, UserService>();
builder.Services.AddScoped<ILicenseService, LicenseService>();
builder.Services.AddScoped<IEntitlementService, EntitlementService>();
builder.Services.AddScoped<ISoftwareCatalogService, SoftwareCatalogService>();
builder.Services.AddScoped<IInstallationService, InstallationService>();
builder.Services.AddScoped<IInstallationHistoryService, InstallationHistoryService>();
builder.Services.AddScoped<IVendorContractService, VendorContractService>();

// ?????????????????????????????????????????????
// CONTROLLERS + JSON SETTINGS
// Prevent reference loop problems
// ?????????????????????????????????????????????
builder.Services.AddControllers()
    .AddJsonOptions(options =>
    {
        options.JsonSerializerOptions.ReferenceHandler = ReferenceHandler.IgnoreCycles;
        options.JsonSerializerOptions.WriteIndented = true;
    });

// ?????????????????????????????????????????????
// Swagger
// ?????????????????????????????????????????????
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();

// ?????????????????????????????????????????????
// CORS (Allow all for development)
// ?????????????????????????????????????????????
builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowAll", policy =>
    {
        policy.AllowAnyOrigin()
              .AllowAnyHeader()
              .AllowAnyMethod();
    });
});


var app = builder.Build();

// ?????????????????????????????????????????????
// MIDDLEWARE PIPELINE
// ?????????????????????????????????????????????
app.UseCors("AllowAll");

if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

app.UseHttpsRedirection();

app.MapControllers();

app.Run();
